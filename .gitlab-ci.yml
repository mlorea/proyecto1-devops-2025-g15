# GitLab CI/CD Pipeline de Seguridad

stages:
  - validate
  - build
  - security
  - report

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ============================================
# STAGE 1: Validaci√≥n de Dockerfile
# ============================================
hadolint:
  stage: validate
  image: hadolint/hadolint:latest-alpine
  script:
    - hadolint Dockerfile --config .hadolint.yaml
  allow_failure: false
  only:
    - branches
    - merge_requests

# ============================================
# STAGE 2: npm audit
# ============================================
npm-audit:
  stage: validate
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - npm audit --json > npm-audit-report.json || true
    - npm audit --audit-level=moderate
  artifacts:
    paths:
      - npm-audit-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================
# STAGE 3: Build Docker Image
# ============================================
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
  only:
    - branches
    - merge_requests

# ============================================
# STAGE 4: Trivy Security Scan
# ============================================
trivy-scan:
  stage: security
  image: aquasec/trivy:latest
  dependencies:
    - build
  before_script:
    - export TRIVY_VERSION=$(wget -qO - "https://api.github.com/repos/aquasecurity/trivy/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
  script:
    # Escaneo completo
    - trivy image --format json --output trivy-report.json ${IMAGE_NAME}:${IMAGE_TAG}
    - trivy image --format table --output trivy-report.txt ${IMAGE_NAME}:${IMAGE_TAG}
    
    # Verificar CRITICAL (fail si encuentra)
    - trivy image --exit-code 1 --severity CRITICAL ${IMAGE_NAME}:${IMAGE_TAG}
    
    # Reporte para GitLab Security Dashboard
    - trivy image --format template --template "@/contrib/gitlab.tpl" --output gl-container-scanning-report.json ${IMAGE_NAME}:${IMAGE_TAG}
  artifacts:
    paths:
      - trivy-report.json
      - trivy-report.txt
    reports:
      container_scanning: gl-container-scanning-report.json
    expire_in: 1 week
  allow_failure: false
  only:
    - branches
    - merge_requests

# ============================================
# STAGE 5: SonarQube (Opcional)
# ============================================
sonarqube-check:
  stage: security
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - sonar-scanner
  allow_failure: true
  only:
    - branches
    - merge_requests
  except:
    - schedules

# ============================================
# STAGE 6: Security Report
# ============================================
security-report:
  stage: report
  image: alpine:latest
  dependencies:
    - npm-audit
    - trivy-scan
  before_script:
    - apk add --no-cache jq
  script:
    - |
      echo "======================================" 
      echo "SECURITY SCAN SUMMARY"
      echo "======================================"
      echo ""
      
      echo "üì¶ npm audit results:"
      if [ -f npm-audit-report.json ]; then
        jq -r '.metadata.vulnerabilities | to_entries[] | "\(.key): \(.value)"' npm-audit-report.json || echo "No vulnerabilities data"
      fi
      
      echo ""
      echo "üîç Trivy results:"
      if [ -f trivy-report.json ]; then
        jq -r '.Results[].Vulnerabilities | length' trivy-report.json | awk '{s+=$1} END {print "Total vulnerabilities: " s}' || echo "No vulnerabilities"
      fi
      
      echo ""
      echo "üìã Detailed reports available in artifacts"
  artifacts:
    paths:
      - npm-audit-report.json
      - trivy-report.json
      - trivy-report.txt
    expire_in: 1 month
  only:
    - branches
    - merge_requests

# ============================================
# JOB SCHEDULED: Nightly Security Scan
# ============================================
nightly-security:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --format json --output trivy-nightly-report.json ${IMAGE_NAME}:latest
    - trivy image --format table ${IMAGE_NAME}:latest
  artifacts:
    paths:
      - trivy-nightly-report.json
    expire_in: 1 week
  only:
    - schedules
