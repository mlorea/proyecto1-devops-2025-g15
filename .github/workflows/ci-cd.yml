name: CI/CD - Proyecto 1 Grupo 15

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:

jobs:
  ci:
    name: IntegraciÃ³n Continua
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias (API)
        run: npm install

      - name: Ejecutar ESLint
        run: |
          npx eslint . || true

      - name: Ejecutar Tests
        run: npm test

      - name: Generar SBOM (CycloneDX)
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: Subir SBOM como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

      - name: Security Audit
        run: npm audit --audit-level=high || true

  cd:
    name: Despliegue
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CÃ³digo
        uses: actions/checkout@v4

      # ---------------------------
      # CONFIGURAR CREDENCIALES AWS
      # ---------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ---------------------------
      # VARIABLES GENERALES
      # ---------------------------
      - name: Set variables
        run: |
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}" >> $GITHUB_ENV
          # Tag Ãºnico: fecha + commit short SHA
          echo "IMAGE_TAG=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:8}" >> $GITHUB_ENV
          echo "ECR_BASE=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com" >> $GITHUB_ENV

          # Nombres de repos ECR (uno por imagen)
          echo "ECR_REPO_APP=proyecto1-todo-api" >> $GITHUB_ENV
          echo "ECR_REPO_PROM=proyecto1-prometheus" >> $GITHUB_ENV
          echo "ECR_REPO_AM=proyecto1-alertmanager" >> $GITHUB_ENV
          echo "ECR_REPO_GRAF=proyecto1-grafana" >> $GITHUB_ENV

      # ---------------------------
      # LOGIN A ECR
      # ---------------------------
      - name: Log in to Amazon ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_BASE"

      # ---------------------------
      # CREAR REPOS ECR SI NO EXISTEN
      # ---------------------------
      - name: Create ECR repos if not exist
        run: |
          for repo in "$ECR_REPO_APP" "$ECR_REPO_PROM" "$ECR_REPO_AM" "$ECR_REPO_GRAF"; do
            aws ecr describe-repositories --repository-names "$repo" >/dev/null 2>&1 \
              || aws ecr create-repository --repository-name "$repo" >/dev/null
          done

      # ---------------------------
      # BUILD + PUSH (APP)
      # ---------------------------
      - name: Build & Push APP
        id: build-app
        run: |
          APP_URI="$ECR_BASE/$ECR_REPO_APP"
          docker build -t "$ECR_REPO_APP:$IMAGE_TAG" .
          docker tag "$ECR_REPO_APP:$IMAGE_TAG" "$APP_URI:$IMAGE_TAG"
          docker push "$APP_URI:$IMAGE_TAG"
          echo "image=$APP_URI:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ---------------------------
      # BUILD + PUSH (PROMETHEUS)
      # ---------------------------
      - name: Build & Push Prometheus
        id: build-prometheus
        run: |
          PROM_URI="$ECR_BASE/$ECR_REPO_PROM"
          docker build -f prometheus/Dockerfile -t "$ECR_REPO_PROM:$IMAGE_TAG" prometheus
          docker tag "$ECR_REPO_PROM:$IMAGE_TAG" "$PROM_URI:$IMAGE_TAG"
          docker push "$PROM_URI:$IMAGE_TAG"
          echo "prometheus_image=$PROM_URI:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ---------------------------
      # BUILD + PUSH (ALERTMANAGER)
      # ---------------------------
      - name: Build & Push Alertmanager
        id: build-alertmanager
        run: |
          AM_URI="$ECR_BASE/$ECR_REPO_AM"
          docker build -f alertmanager/Dockerfile -t "$ECR_REPO_AM:$IMAGE_TAG" alertmanager
          docker tag "$ECR_REPO_AM:$IMAGE_TAG" "$AM_URI:$IMAGE_TAG"
          docker push "$AM_URI:$IMAGE_TAG"
          echo "alertmanager_image=$AM_URI:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ---------------------------
      # BUILD + PUSH (GRAFANA)
      # ---------------------------
      - name: Build & Push Grafana
        id: build-grafana
        run: |
          GRAF_URI="$ECR_BASE/$ECR_REPO_GRAF"
          docker build -f grafana/Dockerfile -t "$ECR_REPO_GRAF:$IMAGE_TAG" grafana
          docker tag "$ECR_REPO_GRAF:$IMAGE_TAG" "$GRAF_URI:$IMAGE_TAG"
          docker push "$GRAF_URI:$IMAGE_TAG"
          echo "grafana_image=$GRAF_URI:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ---------------------------
      # INSTALAR TERRAFORM
      # ---------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      # ---------------------------
      # TERRAFORM DESTROY/APPLY
      # ---------------------------
      - name: Terraform Init
        run: terraform -chdir=terraform init
      
      - name: Terraform Destroy (forzado)
        env:
          TF_VAR_aws_region: ${{ secrets.AWS_REGION }}
          # AÃ±ade valores dummy para las imÃ¡genes (pueden ser cualquier cosa)
          TF_VAR_image: dummy
          TF_VAR_prometheus_image: dummy
          TF_VAR_alertmanager_image: dummy
          TF_VAR_grafana_image: dummy
        run: |
          echo "ðŸš¨ DESTRUYENDO infraestructura existente..."
          terraform -chdir=terraform destroy -auto-approve
      
      - name: Terraform Apply
        env:
          TF_VAR_aws_region: ${{ secrets.AWS_REGION }}
          TF_VAR_image: ${{ steps.build-app.outputs.image }}
          TF_VAR_prometheus_image: ${{ steps.build-prometheus.outputs.prometheus_image }}
          TF_VAR_alertmanager_image: ${{ steps.build-alertmanager.outputs.alertmanager_image }}
          TF_VAR_grafana_image: ${{ steps.build-grafana.outputs.grafana_image }}
        run: |
          echo "ðŸš€ CREANDO nueva infraestructura..."
          terraform -chdir=terraform apply -auto-approve -replace="aws_ecs_task_definition.todo"

      # ---------------------------
      # VERIFICACIÃ“N Y OUTPUTS
      # ---------------------------
      - name: Mostrar URLs de despliegue
        run: |
          echo "âœ… Despliegue completado"
          echo "ðŸ“Š Para ver los outputs:"
          echo "terraform -chdir=terraform output"