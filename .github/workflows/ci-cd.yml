name: CI/CD - Proyecto 1 Grupo 15

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:

jobs:
  ci:
    name: Integración Continua
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias (API)
        run: npm install

      - name: Ejecutar ESLint
        run: |
          npx eslint . || true

      - name: Ejecutar Tests
        run: npm test

      - name: Generar SBOM (CycloneDX)
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: Subir SBOM como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

      - name: Security Audit
        run: npm audit --audit-level=high || true

  cd:
    name: Despliegue
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      # ---------------------------
      # CONFIGURAR CREDENCIALES AWS
      # ---------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ---------------------------
      # VARIABLES GENERALES
      # ---------------------------
      - name: Set variables
        run: |
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "ECR_BASE=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com" >> $GITHUB_ENV
          echo "ECR_REPO_APP=proyecto1-todo-api" >> $GITHUB_ENV

      # ---------------------------
      # LOGIN A ECR
      # ---------------------------
      - name: Log in to Amazon ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_BASE"

      # ---------------------------
      # CREAR REPO ECR (APP) SI NO EXISTE
      # ---------------------------
      - name: Create ECR repo (APP) if not exist
        run: |
          aws ecr describe-repositories --repository-names "$ECR_REPO_APP" >/dev/null 2>&1 \
            || aws ecr create-repository --repository-name "$ECR_REPO_APP" >/dev/null

      # ---------------------------
      # BUILD + PUSH (APP)
      # ---------------------------
      - name: Build & Push APP
        run: |
          APP_URI="$ECR_BASE/$ECR_REPO_APP"
          docker build -t "$ECR_REPO_APP:$IMAGE_TAG" .
          docker tag "$ECR_REPO_APP:$IMAGE_TAG" "$APP_URI:$IMAGE_TAG"
          docker push "$APP_URI:$IMAGE_TAG"
          echo "TF_VAR_image=$APP_URI:$IMAGE_TAG" >> $GITHUB_ENV

      # ---------------------------
      # INSTALAR TERRAFORM
      # ---------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      # ---------------------------
      # TERRAFORM INIT / PLAN / APPLY (no interactivo)
      # ---------------------------
      - name: Terraform Init
        env:
          TF_VAR_aws_region: ${{ secrets.AWS_REGION }}
        run: terraform -chdir=terraform init

      - name: Terraform Plan
        env:
          TF_VAR_aws_region: ${{ secrets.AWS_REGION }}
          TF_VAR_image: ${{ env.TF_VAR_image }}
        run: terraform -chdir=terraform plan -input=false -out=tfplan

      - name: Terraform Apply
        env:
          TF_VAR_aws_region: ${{ secrets.AWS_REGION }}
          TF_VAR_image: ${{ env.TF_VAR_image }}
        run: terraform -chdir=terraform apply -input=false -auto-approve tfplan
