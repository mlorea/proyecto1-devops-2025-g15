name: CI/CD - Proyecto 1 Grupo 15

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:

jobs:
  ci:
    name: Integración Continua
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias (API)
        run: npm install

      - name: Ejecutar ESLint
        run: |
          npx eslint . || true

      - name: Ejecutar Tests
        run: npm test

      - name: Generar SBOM (CycloneDX)
        run: npx @cyclonedx/cyclonedx-npm --output-file sbom.json

      - name: Subir SBOM como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

      - name: Security Audit
        run: npm audit --audit-level=high || true

      # ---------------------------
      # SONARQUBE (SOLO SI EXISTEN SECRETS)
      # ---------------------------
      - name: SonarQube Scan
        if: ${{ secrets.SONAR_TOKEN != '' }}
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  cd:
    name: Despliegue
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      # ---------------------------
      # CONFIGURAR CREDENCIALES AWS
      # ---------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ---------------------------
      # VARIABLES GENERALES
      # ---------------------------
      - name: Set variables
        run: |
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "ECR_BASE=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com" >> $GITHUB_ENV

          # Nombres de repos ECR (uno por imagen)
          echo "ECR_REPO_APP=proyecto1-todo-api" >> $GITHUB_ENV
          echo "ECR_REPO_PROM=proyecto1-prometheus" >> $GITHUB_ENV
          echo "ECR_REPO_AM=proyecto1-alertmanager" >> $GITHUB_ENV
          echo "ECR_REPO_GRAF=proyecto1-grafana" >> $GITHUB_ENV
          echo "ECR_REPO_FE=proyecto1-frontend" >> $GITHUB_ENV

      # ---------------------------
      # LOGIN A ECR
      # ---------------------------
      - name: Log in to Amazon ECR
        run: |
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_BASE"

      # ---------------------------
      # CREAR REPOS ECR SI NO EXISTEN
      # ---------------------------
      - name: Create ECR repos if not exist
        run: |
          for repo in "$ECR_REPO_APP" "$ECR_REPO_PROM" "$ECR_REPO_AM" "$ECR_REPO_GRAF" "$ECR_REPO_FE"; do
            aws ecr describe-repositories --repository-names "$repo" >/dev/null 2>&1 \
              || aws ecr create-repository --repository-name "$repo" >/dev/null
          done

      # ---------------------------
      # BUILD + PUSH (APP)
      # ---------------------------
      - name: Build & Push APP
        run: |
          APP_URI="$ECR_BASE/$ECR_REPO_APP"
          docker build -t "$ECR_REPO_APP:$IMAGE_TAG" .
          docker tag "$ECR_REPO_APP:$IMAGE_TAG" "$APP_URI:$IMAGE_TAG"
          docker push "$APP_URI:$IMAGE_TAG"
          echo "TF_VAR_image=$APP_URI:$IMAGE_TAG" >> $GITHUB_ENV

      # ---------------------------
      # BUILD + PUSH (PROMETHEUS)
      # ---------------------------
      - name: Build & Push Prometheus
        run: |
          PROM_URI="$ECR_BASE/$ECR_REPO_PROM"
          docker build -f prometheus/Dockerfile -t "$ECR_REPO_PROM:$IMAGE_TAG" prometheus
          docker tag "$ECR_REPO_PROM:$IMAGE_TAG" "$PROM_URI:$IMAGE_TAG"
          docker push "$PROM_URI:$IMAGE_TAG"
          echo "TF_VAR_prometheus_image=$PROM_URI:$IMAGE_TAG" >> $GITHUB_ENV

      # ---------------------------
      # BUILD + PUSH (ALERTMANAGER)
      # ---------------------------
      - name: Build & Push Alertmanager
        run: |
          AM_URI="$ECR_BASE/$ECR_REPO_AM"
          docker build -f alertmanager/Dockerfile -t "$ECR_REPO_AM:$IMAGE_TAG" alertmanager
          docker tag "$ECR_REPO_AM:$IMAGE_TAG" "$AM_URI:$IMAGE_TAG"
          docker push "$AM_URI:$IMAGE_TAG"
          echo "TF_VAR_alertmanager_image=$AM_URI:$IMAGE_TAG" >> $GITHUB_ENV

      # ---------------------------
      # BUILD + PUSH (GRAFANA)
      # ---------------------------
      - name: Build & Push Grafana
        run: |
          GRAF_URI="$ECR_BASE/$ECR_REPO_GRAF"
          docker build -f grafana/Dockerfile -t "$ECR_REPO_GRAF:$IMAGE_TAG" grafana
          docker tag "$ECR_REPO_GRAF:$IMAGE_TAG" "$GRAF_URI:$IMAGE_TAG"
          docker push "$GRAF_URI:$IMAGE_TAG"
          echo "TF_VAR_grafana_image=$GRAF_URI:$IMAGE_TAG" >> $GITHUB_ENV

      # ---------------------------
      # BUILD + PUSH (FRONTEND)
      # ---------------------------
      - name: Build & Push Frontend
        run: |
          FE_URI="$ECR_BASE/$ECR_REPO_FE"
          docker build -f frontend/Dockerfile -t "$ECR_REPO_FE:$IMAGE_TAG" frontend
          docker tag "$ECR_REPO_FE:$IMAGE_TAG" "$FE_URI:$IMAGE_TAG"
          docker push "$FE_URI:$IMAGE_TAG"
          echo "TF_VAR_frontend_image=$FE_URI:$IMAGE_TAG" >> $GITHUB_ENV

      # ---------------------------
      # INSTALAR TERRAFORM
      # ---------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      # ---------------------------
      # TERRAFORM INIT/APPLY
      # ---------------------------
      - name: Terraform Init
        env:
          TF_VAR_aws_region: ${{ secrets.AWS_REGION }}
        run: terraform -chdir=terraform init

      - name: Terraform Apply
        env:
          TF_VAR_aws_region: ${{ secrets.AWS_REGION }}
          TF_VAR_image: ${{ env.TF_VAR_image }}
          TF_VAR_prometheus_image: ${{ env.TF_VAR_prometheus_image }}
          TF_VAR_alertmanager_image: ${{ env.TF_VAR_alertmanager_image }}
          TF_VAR_grafana_image: ${{ env.TF_VAR_grafana_image }}
          TF_VAR_frontend_image: ${{ env.TF_VAR_frontend_image }}
        run: terraform -chdir=terraform apply -auto-approve
